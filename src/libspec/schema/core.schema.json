{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://libspec.dev/schema/1.0/core.schema.json",
  "title": "Library Specification Schema",
  "description": "A schema for documenting library interfaces, architecture, and behavioral specifications.",
  "type": "object",
  "required": ["$schema", "library"],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Schema version identifier",
      "pattern": "^libspec/[0-9]+\\.[0-9]+$"
    },
    "extensions": {
      "type": "array",
      "description": "List of extensions to apply to this specification",
      "items": {
        "type": "string",
        "enum": [
          "async", "web", "data", "cli", "orm", "testing", "events", "state", "plugins", "ml",
          "errors", "perf", "safety", "config", "versioning", "observability"
        ]
      },
      "uniqueItems": true,
      "default": []
    },
    "library": {
      "$ref": "#/$defs/Library"
    }
  },

  "$defs": {
    "Library": {
      "type": "object",
      "description": "Root container for a library specification",
      "required": ["name", "version"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Package name (lowercase, underscores allowed)",
          "pattern": "^[a-z][a-z0-9_]*$",
          "minLength": 1,
          "maxLength": 100
        },
        "version": {
          "type": "string",
          "description": "Semantic version string",
          "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+.*$"
        },
        "python_requires": {
          "type": "string",
          "description": "Python version requirement (e.g., '>=3.10')"
        },
        "tagline": {
          "type": "string",
          "description": "One-line description of the library",
          "maxLength": 100
        },
        "description": {
          "type": "string",
          "description": "Longer description (Markdown supported)"
        },
        "repository": {
          "type": "string",
          "description": "URL to source repository",
          "format": "uri"
        },
        "documentation": {
          "type": "string",
          "description": "URL to documentation",
          "format": "uri"
        },
        "principles": {
          "type": "array",
          "description": "Design principles guiding the library",
          "items": { "$ref": "#/$defs/Principle" }
        },
        "modules": {
          "type": "array",
          "description": "Package structure and module definitions",
          "items": { "$ref": "#/$defs/Module" }
        },
        "types": {
          "type": "array",
          "description": "Type definitions (classes, protocols, enums, etc.)",
          "items": { "$ref": "#/$defs/TypeDef" }
        },
        "functions": {
          "type": "array",
          "description": "Top-level function definitions",
          "items": { "$ref": "#/$defs/FunctionDef" }
        },
        "features": {
          "type": "array",
          "description": "Behavioral specifications with test steps",
          "items": { "$ref": "#/$defs/Feature" }
        }
      }
    },

    "Principle": {
      "type": "object",
      "description": "A design principle that guides library decisions",
      "required": ["id", "statement"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this principle",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "statement": {
          "type": "string",
          "description": "Brief principle statement",
          "maxLength": 200
        },
        "rationale": {
          "type": "string",
          "description": "Why this principle exists"
        },
        "implications": {
          "type": "array",
          "description": "Concrete implications of this principle",
          "items": { "type": "string" }
        },
        "anti_patterns": {
          "type": "array",
          "description": "What this principle forbids",
          "items": { "type": "string" }
        }
      }
    },

    "Module": {
      "type": "object",
      "description": "A Python module or package",
      "required": ["path"],
      "additionalProperties": false,
      "properties": {
        "path": {
          "type": "string",
          "description": "Dotted module path (e.g., 'mylib.submodule')"
        },
        "description": {
          "type": "string",
          "description": "What this module provides"
        },
        "exports": {
          "type": "array",
          "description": "Public names exported by this module",
          "items": { "type": "string" }
        },
        "depends_on": {
          "type": "array",
          "description": "Internal module dependencies",
          "items": { "type": "string" }
        },
        "external_deps": {
          "type": "array",
          "description": "External package dependencies",
          "items": { "type": "string" }
        },
        "internal": {
          "type": "boolean",
          "description": "Whether this is a private/internal module",
          "default": false
        }
      }
    },

    "TypeDef": {
      "type": "object",
      "description": "A type definition (class, protocol, enum, etc.)",
      "required": ["name", "kind", "module"],
      "additionalProperties": true,
      "properties": {
        "name": {
          "type": "string",
          "description": "Type name"
        },
        "kind": {
          "type": "string",
          "description": "Kind of type",
          "enum": ["class", "dataclass", "protocol", "enum", "type_alias", "namedtuple"]
        },
        "module": {
          "type": "string",
          "description": "Module where this type is defined"
        },
        "generic_params": {
          "type": "array",
          "description": "Generic type parameters",
          "items": { "$ref": "#/$defs/GenericParam" }
        },
        "bases": {
          "type": "array",
          "description": "Base classes or protocols",
          "items": { "type": "string" }
        },
        "docstring": {
          "type": "string",
          "description": "What this type represents"
        },
        "type_target": {
          "type": "string",
          "description": "For type_alias: the aliased type"
        },
        "properties": {
          "type": "array",
          "description": "Instance properties/attributes",
          "items": { "$ref": "#/$defs/Property" }
        },
        "methods": {
          "type": "array",
          "description": "Instance methods",
          "items": { "$ref": "#/$defs/Method" }
        },
        "class_methods": {
          "type": "array",
          "description": "Class methods",
          "items": { "$ref": "#/$defs/Method" }
        },
        "static_methods": {
          "type": "array",
          "description": "Static methods",
          "items": { "$ref": "#/$defs/Method" }
        },
        "values": {
          "type": "array",
          "description": "Enum values (only for kind='enum')",
          "items": { "$ref": "#/$defs/EnumValue" }
        },
        "invariants": {
          "type": "array",
          "description": "Statements that are always true for valid instances",
          "items": { "type": "string" }
        },
        "construction": {
          "$ref": "#/$defs/Constructor",
          "description": "Constructor specification"
        },
        "related": {
          "type": "array",
          "description": "Related types or functions (cross-references)",
          "items": { "type": "string" }
        },
        "example": {
          "type": "string",
          "description": "Code example showing typical usage"
        }
      }
    },

    "GenericParam": {
      "type": "object",
      "description": "A generic type parameter",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Parameter name (e.g., 'T', 'K', 'V')"
        },
        "bound": {
          "type": "string",
          "description": "Upper bound type constraint"
        },
        "variance": {
          "type": "string",
          "description": "Variance of the parameter",
          "enum": ["invariant", "covariant", "contravariant"],
          "default": "invariant"
        },
        "default": {
          "type": "string",
          "description": "Default type if not specified (Python 3.12+)"
        }
      }
    },

    "Property": {
      "type": "object",
      "description": "An instance property or attribute",
      "required": ["name", "type"],
      "additionalProperties": true,
      "properties": {
        "name": {
          "type": "string",
          "description": "Property name"
        },
        "type": {
          "type": "string",
          "description": "Property type annotation"
        },
        "readonly": {
          "type": "boolean",
          "description": "Whether this is a read-only property",
          "default": false
        },
        "default": {
          "type": "string",
          "description": "Default value (as a string representation)"
        },
        "description": {
          "type": "string",
          "description": "What this property represents"
        }
      }
    },

    "Method": {
      "type": "object",
      "description": "A method definition",
      "required": ["name", "signature"],
      "additionalProperties": true,
      "properties": {
        "name": {
          "type": "string",
          "description": "Method name"
        },
        "signature": {
          "type": "string",
          "description": "Full signature including parameters and return type"
        },
        "description": {
          "type": "string",
          "description": "What this method does"
        },
        "parameters": {
          "type": "array",
          "description": "Detailed parameter specifications",
          "items": { "$ref": "#/$defs/Parameter" }
        },
        "returns": {
          "$ref": "#/$defs/ReturnSpec",
          "description": "Return value specification"
        },
        "preconditions": {
          "type": "array",
          "description": "State requirements before calling this method",
          "items": { "type": "string" }
        },
        "postconditions": {
          "type": "array",
          "description": "Guaranteed state after this method completes",
          "items": { "type": "string" }
        },
        "raises": {
          "type": "array",
          "description": "Exceptions this method may raise",
          "items": { "$ref": "#/$defs/RaisesClause" }
        },
        "inherited_from": {
          "type": "string",
          "description": "Base class this method is inherited from (if any)"
        }
      }
    },

    "Parameter": {
      "type": "object",
      "description": "A function or method parameter",
      "required": ["name", "type"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Parameter name"
        },
        "type": {
          "type": "string",
          "description": "Parameter type annotation"
        },
        "default": {
          "type": "string",
          "description": "Default value (string 'REQUIRED' means no default)"
        },
        "description": {
          "type": "string",
          "description": "What this parameter controls"
        },
        "kind": {
          "type": "string",
          "description": "Parameter kind",
          "enum": ["positional_only", "positional_or_keyword", "keyword_only", "var_positional", "var_keyword"],
          "default": "positional_or_keyword"
        }
      }
    },

    "ReturnSpec": {
      "type": "object",
      "description": "Return value specification",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "description": "Return type annotation"
        },
        "description": {
          "type": "string",
          "description": "What the return value represents"
        }
      }
    },

    "YieldSpec": {
      "type": "object",
      "description": "Yield value specification for generators",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "description": "Yielded type annotation"
        },
        "description": {
          "type": "string",
          "description": "What each yielded value represents"
        }
      }
    },

    "RaisesClause": {
      "type": "object",
      "description": "An exception that may be raised",
      "required": ["type", "when"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "description": "Exception type name"
        },
        "when": {
          "type": "string",
          "description": "Condition under which this exception is raised"
        }
      }
    },

    "EnumValue": {
      "type": "object",
      "description": "An enum member value",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Enum member name"
        },
        "value": {
          "type": "string",
          "description": "Enum member value (e.g., 'auto()' or explicit value)"
        },
        "description": {
          "type": "string",
          "description": "What this enum value represents"
        }
      }
    },

    "Constructor": {
      "type": "object",
      "description": "Constructor specification",
      "additionalProperties": false,
      "properties": {
        "signature": {
          "type": "string",
          "description": "Constructor signature"
        },
        "parameters": {
          "type": "array",
          "description": "Constructor parameters",
          "items": { "$ref": "#/$defs/Parameter" }
        },
        "validates": {
          "type": "array",
          "description": "Validation performed during construction",
          "items": { "type": "string" }
        },
        "raises": {
          "type": "array",
          "description": "Exceptions that may be raised during construction",
          "items": { "$ref": "#/$defs/RaisesClause" }
        }
      }
    },

    "FunctionDef": {
      "type": "object",
      "description": "A top-level function definition",
      "required": ["name", "kind", "module", "signature"],
      "additionalProperties": true,
      "properties": {
        "name": {
          "type": "string",
          "description": "Function name"
        },
        "kind": {
          "type": "string",
          "description": "Kind of callable",
          "enum": ["function", "decorator", "context_manager", "async_context_manager"]
        },
        "module": {
          "type": "string",
          "description": "Module where this function is defined"
        },
        "signature": {
          "type": "string",
          "description": "Full signature including parameters and return type"
        },
        "generic_params": {
          "type": "array",
          "description": "Generic type parameters",
          "items": { "$ref": "#/$defs/GenericParam" }
        },
        "parameters": {
          "type": "array",
          "description": "Detailed parameter specifications",
          "items": { "$ref": "#/$defs/Parameter" }
        },
        "returns": {
          "$ref": "#/$defs/ReturnSpec",
          "description": "Return value specification"
        },
        "yields": {
          "$ref": "#/$defs/YieldSpec",
          "description": "Yield value specification (for generators)"
        },
        "description": {
          "type": "string",
          "description": "What this function does"
        },
        "preconditions": {
          "type": "array",
          "description": "State requirements before calling",
          "items": { "type": "string" }
        },
        "postconditions": {
          "type": "array",
          "description": "Guaranteed state after completion",
          "items": { "type": "string" }
        },
        "invariants": {
          "type": "array",
          "description": "Invariants maintained by this function",
          "items": { "type": "string" }
        },
        "raises": {
          "type": "array",
          "description": "Exceptions this function may raise",
          "items": { "$ref": "#/$defs/RaisesClause" }
        },
        "idempotent": {
          "type": "boolean",
          "description": "Whether calling multiple times has same effect as once"
        },
        "pure": {
          "type": "boolean",
          "description": "Whether this function has no side effects"
        },
        "deterministic": {
          "type": "boolean",
          "description": "Whether same inputs always produce same outputs"
        },
        "related": {
          "type": "array",
          "description": "Related types or functions",
          "items": { "type": "string" }
        },
        "example": {
          "type": "string",
          "description": "Code example showing typical usage"
        }
      }
    },

    "Feature": {
      "type": "object",
      "description": "A behavioral specification with test steps",
      "required": ["id", "category", "description"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this feature"
        },
        "category": {
          "type": "string",
          "description": "Feature category (SCREAMING_SNAKE_CASE)",
          "pattern": "^[A-Z][A-Z0-9_]*$"
        },
        "summary": {
          "type": "string",
          "description": "One-line summary",
          "maxLength": 100
        },
        "description": {
          "type": "string",
          "description": "Detailed behavioral description"
        },
        "steps": {
          "type": "array",
          "description": "Verification/test steps",
          "items": { "type": "string" }
        },
        "references": {
          "type": "array",
          "description": "Cross-references to types, methods, or functions",
          "items": { "type": "string" }
        },
        "status": {
          "type": "string",
          "description": "Implementation status",
          "enum": ["planned", "implemented", "tested"],
          "default": "planned"
        },
        "breaking_since": {
          "type": ["string", "null"],
          "description": "Version where this became a breaking change (null if never)"
        },
        "v1_planned": {
          "type": "array",
          "description": "Features planned for v1 but not in v0",
          "items": { "type": "string" }
        }
      }
    }
  }
}
