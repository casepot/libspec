{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://libspec.dev/schema/1.0/extensions/events.schema.json",
  "title": "Events Extension",
  "description": "Extension for event-driven architectures: events, handlers, buses, pub/sub.",

  "$defs": {
    "EventsLibraryFields": {
      "description": "Fields added to Library when events extension is active",
      "type": "object",
      "properties": {
        "events": {
          "type": "array",
          "description": "Event type definitions",
          "items": { "$ref": "#/$defs/EventSpec" }
        },
        "handlers": {
          "type": "array",
          "description": "Event handler definitions",
          "items": { "$ref": "#/$defs/HandlerSpec" }
        },
        "event_bus": {
          "$ref": "#/$defs/EventBusSpec"
        },
        "topics": {
          "type": "array",
          "description": "Topic/channel definitions",
          "items": { "$ref": "#/$defs/TopicSpec" }
        },
        "sagas": {
          "type": "array",
          "description": "Saga/process manager definitions",
          "items": { "$ref": "#/$defs/SagaSpec" }
        }
      }
    },

    "EventsTypeFields": {
      "description": "Fields added to TypeDef when events extension is active",
      "type": "object",
      "properties": {
        "emits": {
          "type": "array",
          "description": "Events this type emits",
          "items": { "type": "string" }
        },
        "handles": {
          "type": "array",
          "description": "Events this type handles",
          "items": { "type": "string" }
        },
        "domain_events": {
          "type": "boolean",
          "description": "Whether this is a domain event aggregate"
        }
      }
    },

    "EventsMethodFields": {
      "description": "Fields added to Method when events extension is active",
      "type": "object",
      "properties": {
        "emits": {
          "type": "array",
          "description": "Events this method emits",
          "items": { "type": "string" }
        },
        "triggers_on": {
          "type": "array",
          "description": "Events that trigger this method",
          "items": { "type": "string" }
        }
      }
    },

    "EventSpec": {
      "type": "object",
      "description": "An event type definition",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Event type name"
        },
        "type": {
          "type": "string",
          "description": "Event class reference"
        },
        "category": {
          "type": "string",
          "description": "Event category",
          "enum": ["domain", "integration", "notification", "system", "command", "query"]
        },
        "payload": {
          "type": "array",
          "description": "Event payload fields",
          "items": { "$ref": "#/$defs/EventFieldSpec" }
        },
        "metadata": {
          "type": "array",
          "description": "Standard metadata fields",
          "items": { "$ref": "#/$defs/EventFieldSpec" }
        },
        "topic": {
          "type": "string",
          "description": "Default topic/channel"
        },
        "version": {
          "type": "string",
          "description": "Event schema version"
        },
        "idempotency_key": {
          "type": "string",
          "description": "Field used for idempotency"
        },
        "ordering_key": {
          "type": "string",
          "description": "Field used for ordering"
        },
        "ttl": {
          "type": "string",
          "description": "Event time-to-live"
        },
        "description": {
          "type": "string"
        }
      }
    },

    "EventFieldSpec": {
      "type": "object",
      "description": "An event field",
      "required": ["name", "type"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Field name"
        },
        "type": {
          "type": "string",
          "description": "Field type"
        },
        "required": {
          "type": "boolean",
          "description": "Whether field is required",
          "default": true
        },
        "description": {
          "type": "string"
        }
      }
    },

    "HandlerSpec": {
      "type": "object",
      "description": "An event handler",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Handler name"
        },
        "handles": {
          "type": "array",
          "description": "Events this handler processes",
          "items": { "type": "string" }
        },
        "function": {
          "type": "string",
          "description": "Handler function reference"
        },
        "async": {
          "type": "boolean",
          "description": "Whether handler is async"
        },
        "retry": {
          "$ref": "#/$defs/RetrySpec"
        },
        "timeout": {
          "type": "number",
          "description": "Handler timeout in seconds"
        },
        "concurrency": {
          "type": "integer",
          "description": "Max concurrent executions"
        },
        "ordering": {
          "type": "string",
          "description": "Event ordering guarantee",
          "enum": ["none", "fifo", "partition_fifo"]
        },
        "idempotent": {
          "type": "boolean",
          "description": "Whether handler is idempotent"
        },
        "dead_letter": {
          "type": "string",
          "description": "Dead letter topic on failure"
        },
        "filters": {
          "type": "array",
          "description": "Event filters",
          "items": { "$ref": "#/$defs/EventFilterSpec" }
        },
        "description": {
          "type": "string"
        }
      }
    },

    "RetrySpec": {
      "type": "object",
      "description": "Retry configuration",
      "properties": {
        "max_attempts": {
          "type": "integer",
          "description": "Maximum retry attempts"
        },
        "backoff": {
          "type": "string",
          "description": "Backoff strategy",
          "enum": ["fixed", "exponential", "linear", "fibonacci"]
        },
        "initial_delay": {
          "type": "number",
          "description": "Initial delay in seconds"
        },
        "max_delay": {
          "type": "number",
          "description": "Maximum delay in seconds"
        },
        "jitter": {
          "type": "boolean",
          "description": "Whether to add jitter"
        },
        "retryable_exceptions": {
          "type": "array",
          "description": "Exceptions that trigger retry",
          "items": { "type": "string" }
        }
      }
    },

    "EventFilterSpec": {
      "type": "object",
      "description": "An event filter",
      "properties": {
        "field": {
          "type": "string",
          "description": "Field to filter on"
        },
        "operator": {
          "type": "string",
          "description": "Filter operator",
          "enum": ["eq", "neq", "gt", "gte", "lt", "lte", "in", "contains", "regex"]
        },
        "value": {
          "description": "Filter value"
        }
      }
    },

    "EventBusSpec": {
      "type": "object",
      "description": "Event bus configuration",
      "properties": {
        "type": {
          "type": "string",
          "description": "Event bus type",
          "enum": ["in_memory", "redis", "rabbitmq", "kafka", "sqs", "pubsub", "nats", "custom"]
        },
        "async_dispatch": {
          "type": "boolean",
          "description": "Whether dispatch is async"
        },
        "guaranteed_delivery": {
          "type": "boolean",
          "description": "Whether delivery is guaranteed"
        },
        "ordering_guarantee": {
          "type": "string",
          "description": "Ordering guarantee level",
          "enum": ["none", "per_partition", "global"]
        },
        "at_least_once": {
          "type": "boolean",
          "description": "At-least-once delivery"
        },
        "at_most_once": {
          "type": "boolean",
          "description": "At-most-once delivery"
        },
        "exactly_once": {
          "type": "boolean",
          "description": "Exactly-once delivery"
        },
        "transactional_outbox": {
          "type": "boolean",
          "description": "Whether transactional outbox pattern is supported"
        },
        "event_sourcing": {
          "type": "boolean",
          "description": "Whether event sourcing is supported"
        }
      }
    },

    "TopicSpec": {
      "type": "object",
      "description": "A topic/channel definition",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Topic name"
        },
        "pattern": {
          "type": "string",
          "description": "Topic pattern (for wildcards)"
        },
        "partitions": {
          "type": "integer",
          "description": "Number of partitions"
        },
        "retention": {
          "type": "string",
          "description": "Message retention period"
        },
        "events": {
          "type": "array",
          "description": "Event types published to this topic",
          "items": { "type": "string" }
        },
        "subscribers": {
          "type": "array",
          "description": "Subscriber handler names",
          "items": { "type": "string" }
        },
        "description": {
          "type": "string"
        }
      }
    },

    "SagaSpec": {
      "type": "object",
      "description": "A saga/process manager definition",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Saga name"
        },
        "type": {
          "type": "string",
          "description": "Saga class reference"
        },
        "starts_with": {
          "type": "array",
          "description": "Events that start this saga",
          "items": { "type": "string" }
        },
        "steps": {
          "type": "array",
          "description": "Saga steps",
          "items": { "$ref": "#/$defs/SagaStepSpec" }
        },
        "compensations": {
          "type": "array",
          "description": "Compensation actions",
          "items": { "$ref": "#/$defs/CompensationSpec" }
        },
        "timeout": {
          "type": "number",
          "description": "Saga timeout in seconds"
        },
        "persistence": {
          "type": "string",
          "description": "State persistence strategy",
          "enum": ["in_memory", "database", "event_store"]
        },
        "description": {
          "type": "string"
        }
      }
    },

    "SagaStepSpec": {
      "type": "object",
      "description": "A saga step",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Step name"
        },
        "action": {
          "type": "string",
          "description": "Action to perform (command/event)"
        },
        "wait_for": {
          "type": "array",
          "description": "Events to wait for",
          "items": { "type": "string" }
        },
        "timeout": {
          "type": "number",
          "description": "Step timeout in seconds"
        },
        "on_failure": {
          "type": "string",
          "description": "Failure handling",
          "enum": ["compensate", "retry", "skip", "abort"]
        }
      }
    },

    "CompensationSpec": {
      "type": "object",
      "description": "A compensation action",
      "required": ["step", "action"],
      "properties": {
        "step": {
          "type": "string",
          "description": "Step to compensate"
        },
        "action": {
          "type": "string",
          "description": "Compensation action"
        },
        "idempotent": {
          "type": "boolean",
          "description": "Whether compensation is idempotent"
        }
      }
    }
  }
}
