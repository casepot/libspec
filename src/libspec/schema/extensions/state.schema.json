{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://libspec.dev/schema/1.0/extensions/state.schema.json",
  "title": "State Extension",
  "description": "Extension for state management: state machines, reducers, selectors, stores.",

  "$defs": {
    "StateLibraryFields": {
      "description": "Fields added to Library when state extension is active",
      "type": "object",
      "properties": {
        "stores": {
          "type": "array",
          "description": "State store definitions",
          "items": { "$ref": "#/$defs/StoreSpec" }
        },
        "state_machines": {
          "type": "array",
          "description": "State machine definitions",
          "items": { "$ref": "#/$defs/StateMachineSpec" }
        },
        "actions": {
          "type": "array",
          "description": "Action definitions",
          "items": { "$ref": "#/$defs/ActionSpec" }
        },
        "selectors": {
          "type": "array",
          "description": "Selector definitions",
          "items": { "$ref": "#/$defs/SelectorSpec" }
        },
        "middleware": {
          "type": "array",
          "description": "State middleware",
          "items": { "$ref": "#/$defs/StateMiddlewareSpec" }
        }
      }
    },

    "StateTypeFields": {
      "description": "Fields added to TypeDef when state extension is active",
      "type": "object",
      "properties": {
        "state_shape": {
          "$ref": "#/$defs/StateShapeSpec"
        },
        "immutable": {
          "type": "boolean",
          "description": "Whether state is immutable"
        },
        "serializable": {
          "type": "boolean",
          "description": "Whether state is serializable"
        }
      }
    },

    "StoreSpec": {
      "type": "object",
      "description": "A state store definition",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Store name"
        },
        "type": {
          "type": "string",
          "description": "Store implementation type",
          "enum": ["redux", "mobx", "zustand", "recoil", "pinia", "custom"]
        },
        "state_type": {
          "type": "string",
          "description": "State type reference"
        },
        "initial_state": {
          "type": "string",
          "description": "Initial state factory reference"
        },
        "reducers": {
          "type": "array",
          "description": "Reducer functions",
          "items": { "$ref": "#/$defs/ReducerSpec" }
        },
        "slices": {
          "type": "array",
          "description": "State slices",
          "items": { "$ref": "#/$defs/SliceSpec" }
        },
        "persistence": {
          "$ref": "#/$defs/PersistenceSpec"
        },
        "devtools": {
          "type": "boolean",
          "description": "Whether devtools integration is supported"
        },
        "description": {
          "type": "string"
        }
      }
    },

    "ReducerSpec": {
      "type": "object",
      "description": "A reducer function",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Reducer name"
        },
        "function": {
          "type": "string",
          "description": "Reducer function reference"
        },
        "handles": {
          "type": "array",
          "description": "Action types this reducer handles",
          "items": { "type": "string" }
        },
        "pure": {
          "type": "boolean",
          "description": "Whether reducer is pure"
        },
        "description": {
          "type": "string"
        }
      }
    },

    "SliceSpec": {
      "type": "object",
      "description": "A state slice",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Slice name"
        },
        "path": {
          "type": "string",
          "description": "Path in state tree"
        },
        "state_type": {
          "type": "string",
          "description": "Slice state type"
        },
        "reducers": {
          "type": "array",
          "description": "Slice reducers",
          "items": { "$ref": "#/$defs/ReducerSpec" }
        },
        "actions": {
          "type": "array",
          "description": "Auto-generated action names",
          "items": { "type": "string" }
        },
        "selectors": {
          "type": "array",
          "description": "Slice selectors",
          "items": { "type": "string" }
        },
        "extra_reducers": {
          "type": "array",
          "description": "External action handlers",
          "items": { "type": "string" }
        }
      }
    },

    "StateMachineSpec": {
      "type": "object",
      "description": "A finite state machine definition",
      "required": ["name", "states", "initial"],
      "properties": {
        "name": {
          "type": "string",
          "description": "State machine name"
        },
        "type": {
          "type": "string",
          "description": "State machine class reference"
        },
        "states": {
          "type": "array",
          "description": "State definitions",
          "items": { "$ref": "#/$defs/MachineStateSpec" }
        },
        "initial": {
          "type": "string",
          "description": "Initial state name"
        },
        "context_type": {
          "type": "string",
          "description": "Context/extended state type"
        },
        "events": {
          "type": "array",
          "description": "Event definitions",
          "items": { "$ref": "#/$defs/MachineEventSpec" }
        },
        "transitions": {
          "type": "array",
          "description": "Transition definitions",
          "items": { "$ref": "#/$defs/TransitionSpec" }
        },
        "guards": {
          "type": "array",
          "description": "Guard conditions",
          "items": { "$ref": "#/$defs/GuardSpec" }
        },
        "actions": {
          "type": "array",
          "description": "Side effect actions",
          "items": { "$ref": "#/$defs/MachineActionSpec" }
        },
        "services": {
          "type": "array",
          "description": "Invoked services",
          "items": { "$ref": "#/$defs/ServiceSpec" }
        },
        "hierarchical": {
          "type": "boolean",
          "description": "Whether machine has nested states"
        },
        "parallel": {
          "type": "boolean",
          "description": "Whether machine has parallel states"
        },
        "description": {
          "type": "string"
        }
      }
    },

    "MachineStateSpec": {
      "type": "object",
      "description": "A state in a state machine",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "State name"
        },
        "type": {
          "type": "string",
          "description": "State type",
          "enum": ["atomic", "compound", "parallel", "final", "history"]
        },
        "entry": {
          "type": "array",
          "description": "Entry actions",
          "items": { "type": "string" }
        },
        "exit": {
          "type": "array",
          "description": "Exit actions",
          "items": { "type": "string" }
        },
        "on": {
          "type": "object",
          "description": "Event handlers (event -> transition)",
          "additionalProperties": { "type": "string" }
        },
        "invoke": {
          "type": "array",
          "description": "Invoked services in this state",
          "items": { "type": "string" }
        },
        "children": {
          "type": "array",
          "description": "Child states (for compound/parallel)",
          "items": { "$ref": "#/$defs/MachineStateSpec" }
        },
        "initial": {
          "type": "string",
          "description": "Initial child state"
        },
        "tags": {
          "type": "array",
          "description": "State tags for querying",
          "items": { "type": "string" }
        },
        "description": {
          "type": "string"
        }
      }
    },

    "MachineEventSpec": {
      "type": "object",
      "description": "An event in a state machine",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Event name"
        },
        "payload_type": {
          "type": "string",
          "description": "Event payload type"
        },
        "description": {
          "type": "string"
        }
      }
    },

    "TransitionSpec": {
      "type": "object",
      "description": "A state transition",
      "properties": {
        "from": {
          "type": "string",
          "description": "Source state"
        },
        "to": {
          "type": "string",
          "description": "Target state"
        },
        "event": {
          "type": "string",
          "description": "Triggering event"
        },
        "guard": {
          "type": "string",
          "description": "Guard condition"
        },
        "actions": {
          "type": "array",
          "description": "Transition actions",
          "items": { "type": "string" }
        },
        "internal": {
          "type": "boolean",
          "description": "Whether transition is internal (no exit/entry)"
        },
        "description": {
          "type": "string"
        }
      }
    },

    "GuardSpec": {
      "type": "object",
      "description": "A guard condition",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Guard name"
        },
        "function": {
          "type": "string",
          "description": "Guard function reference"
        },
        "condition": {
          "type": "string",
          "description": "Condition description"
        }
      }
    },

    "MachineActionSpec": {
      "type": "object",
      "description": "A state machine action",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Action name"
        },
        "function": {
          "type": "string",
          "description": "Action function reference"
        },
        "type": {
          "type": "string",
          "description": "Action type",
          "enum": ["assign", "raise", "send", "log", "custom"]
        },
        "description": {
          "type": "string"
        }
      }
    },

    "ServiceSpec": {
      "type": "object",
      "description": "An invoked service",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Service name"
        },
        "type": {
          "type": "string",
          "description": "Service type",
          "enum": ["promise", "callback", "observable", "machine"]
        },
        "src": {
          "type": "string",
          "description": "Service source/function reference"
        },
        "on_done": {
          "type": "string",
          "description": "Transition on success"
        },
        "on_error": {
          "type": "string",
          "description": "Transition on error"
        }
      }
    },

    "ActionSpec": {
      "type": "object",
      "description": "A state action definition",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Action type name"
        },
        "type": {
          "type": "string",
          "description": "Action creator type reference"
        },
        "payload_type": {
          "type": "string",
          "description": "Payload type"
        },
        "creator": {
          "type": "string",
          "description": "Action creator function reference"
        },
        "async": {
          "type": "boolean",
          "description": "Whether this is an async action/thunk"
        },
        "description": {
          "type": "string"
        }
      }
    },

    "SelectorSpec": {
      "type": "object",
      "description": "A state selector",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Selector name"
        },
        "function": {
          "type": "string",
          "description": "Selector function reference"
        },
        "input_selectors": {
          "type": "array",
          "description": "Input selectors (for memoization)",
          "items": { "type": "string" }
        },
        "return_type": {
          "type": "string",
          "description": "Return type"
        },
        "memoized": {
          "type": "boolean",
          "description": "Whether selector is memoized"
        },
        "description": {
          "type": "string"
        }
      }
    },

    "StateMiddlewareSpec": {
      "type": "object",
      "description": "State middleware",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Middleware name"
        },
        "type": {
          "type": "string",
          "description": "Middleware type reference"
        },
        "order": {
          "type": "integer",
          "description": "Execution order"
        },
        "intercepts": {
          "type": "array",
          "description": "What this middleware intercepts",
          "items": {
            "type": "string",
            "enum": ["actions", "state", "dispatch", "subscribe"]
          }
        },
        "description": {
          "type": "string"
        }
      }
    },

    "StateShapeSpec": {
      "type": "object",
      "description": "State shape definition",
      "properties": {
        "normalized": {
          "type": "boolean",
          "description": "Whether state is normalized"
        },
        "entities": {
          "type": "array",
          "description": "Entity types in state",
          "items": { "type": "string" }
        },
        "ids_key": {
          "type": "string",
          "description": "Key for ID arrays",
          "default": "ids"
        },
        "entities_key": {
          "type": "string",
          "description": "Key for entity maps",
          "default": "entities"
        }
      }
    },

    "PersistenceSpec": {
      "type": "object",
      "description": "State persistence configuration",
      "properties": {
        "storage": {
          "type": "string",
          "description": "Storage type",
          "enum": ["localStorage", "sessionStorage", "indexedDB", "asyncStorage", "custom"]
        },
        "key": {
          "type": "string",
          "description": "Storage key"
        },
        "whitelist": {
          "type": "array",
          "description": "Paths to persist",
          "items": { "type": "string" }
        },
        "blacklist": {
          "type": "array",
          "description": "Paths to exclude",
          "items": { "type": "string" }
        },
        "version": {
          "type": "integer",
          "description": "Persistence version"
        },
        "migrate": {
          "type": "string",
          "description": "Migration function reference"
        }
      }
    }
  }
}
